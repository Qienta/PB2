#2 April 2023
import json
import os


from linebot import (
    LineBotApi, WebhookHandler
)
from linebot.models import (
    MessageEvent, TextMessage, TextSendMessage,AudioMessage,AudioSendMessage,
)

def lambda_handler(event, context):
    line_bot_api = LineBotApi(os.environ['YOUR_CHANNEL_ACCESS_TOKEN'])
    handler = WebhookHandler(os.environ['YOUR_CHANNEL_SECRET'])

    msg = json.loads(event['body'])
    
    #checking message type
    if msg['events'][0]['message']['type'] == "audio":
        
        #get audio file path
        message_id = msg['events'][0]['message']['id']
        message_content = line_bot_api.get_message_content(message_id).content
        file_path = "https://api-data.line.me/v2/bot/message/"+message_id+"/content"
        
        #copy file from the path
        with open(file_path, 'wb') as fd:
            for chunk in message_content.iter_content():
                fd.write(chunk)

        line_bot_api.reply_message(
            msg['events'][0]['replyToken'],
            AudioSendMessage(original_content_url=file_path, duration=int(msg['events'][0]['message']['duration']))
        )
        
    else:
        line_bot_api.reply_message(
            msg['events'][0]['replyToken'],
            TextSendMessage(text="N other")
        )
    

    return {
        "statusCode": 200,
        "body": json.dumps({"message": 'ok'})
    }
